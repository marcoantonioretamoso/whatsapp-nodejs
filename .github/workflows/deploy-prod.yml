name: Verificar, Construir y Desplegar en Prod

on:
  push:
    branches:
      - prod

jobs:
  build:
    name: ğŸ—ï¸ Construir y Verificar
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Clonando el repositorio
        uses: actions/checkout@v4

      - name: ğŸ˜ Configurando PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3.6"
          extensions: mbstring, dom, fileinfo, mysql
          coverage: none

      - name: ğŸ“¦ Configurando Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.16.0"
          cache: "npm"

      # 4. Instala dependencias de Composer
      - name: ğŸ¶ Instalando dependencias de Composer
        run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      # 5. Instala dependencias de NPM
      - name: NPM install
        run: npm install

      # 6. Prepara el archivo .env para el build
      # El build necesita un .env para funcionar, pero no necesita los secretos reales
      - name: Preparando archivo .env
        run: cp .env.example .env

      - name: Generando clave de la aplicaciÃ³n
        run: php artisan key:generate

      # 7. Construye la aplicaciÃ³n (EL PASO DE VERIFICACIÃ“N CLAVE)
      - name: ğŸ”¨ Construyendo la aplicaciÃ³n (Vite)
        run: npm run build

    # 8. (Opcional pero recomendado) Ejecutar tests
    # - name: ğŸ§ª Ejecutando tests de Laravel
    #   run: php artisan test

  deploy:
    name: ğŸš€ Desplegar en Servidor
    runs-on: ubuntu-latest

    needs: build

    steps:
      - name: ğŸšš Ejecutar script de despliegue en el servidor de Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 5225

          script: /var/www/targetbit_co_usr86/data/ecom.sh
